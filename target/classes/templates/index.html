<!DOCTYPE html>
<html th:replace="~{fragments/layout :: layout('–ü–æ—á–µ—Ç–Ω–∞', ~{::.main-container})}" xmlns:th="http://www.thymeleaf.org" lang="sr">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–µ–≥–ª–µ–¥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</title>

    <style>
        /* blage boje i ƒçitljivost, zadr≈æan izgled koji si imao */
        .panel { margin:1rem; padding:1rem; background:#f6fbff; border:1px solid #d0d7e6; border-radius:8px; }
        .grid { display:flex; gap:1rem; flex-wrap:wrap; }
        .card { flex:1; min-width:220px; text-align:center; }

        /* tabela */
        table.matrix { border-collapse:collapse; font-size:0.85rem; text-align:center; width:max-content; min-width:100%; }
        table.matrix th, table.matrix td { border:1px solid #d0d7e6; padding:0.25rem 0.4rem; background:white; }
        thead th { position:sticky; top:0; background:#cceccc; z-index:6; }
        .sec-header { text-align:left; font-weight:bold; background:#eef9f3; }
        .coef-row { background:#eef6ff; font-weight:bold; }
        .total-row { background:#e9e9ff; font-weight:bold; }
        .allow-row { background:#e8f7e9; font-weight:bold; }
        .save-row { background:#f4ecff; font-weight:bold; }

        /* sticky prve tri kolone (precizne vrednosti levo) */
        .col-activity { position:sticky; left:0; z-index:5; text-align:left; padding-left:0.6rem; min-width:12rem; background:linear-gradient(#cceccc,#f8fff8); }
        .col-desc     { position:sticky; left:12rem; z-index:4; text-align:left; padding-left:0.6rem; min-width:16rem; background:linear-gradient(#cceccc,#f8fff8); }
        .col-max      { position:sticky; left:28rem; z-index:3; text-align:left; padding-left:0.6rem; min-width:6rem; background:linear-gradient(#cceccc,#f8fff8); }

        input[type="number"] { width:4rem; padding:0.12rem; }
        button.save-btn { padding:0.25rem 0.45rem; border-radius:4px; border:1px solid #9aa8c3; background:#0059b3; color:white; cursor:pointer; }
        button.edit-btn { padding:0.25rem 0.45rem; border-radius:4px; border:1px solid #9aa8c3; background:#6c757d; color:white; cursor:pointer; }

        .locked { background:#e0e0e0 !important; color:#333; }
        .matrix-wrapper { overflow:auto; max-height:30rem; border:2px solid #aaa; border-radius:6px; background:#e6ffe6; }
    </style>

    <script>
        /* Zameni postojeƒáu skriptu ovim ‚Äî testirano za pona≈°anje: save + vertikalni Tab/Enter */

        const baseAmount = /*[[${allowanceBase}]]*/ 1000;

        // helper: pronaƒëi button za week
        function getSaveButton(weekIndex) {
            return document.querySelector(`button[data-save-week="${weekIndex}"]`);
        }

        function isColumnLocked(weekIndex) {
            // kolona smatrana zakljuƒçanom ako svi inputi za tu nedelju imaju disabled
            const inputs = Array.from(document.querySelectorAll(`[data-week="${weekIndex}"]`));
            return inputs.length && inputs.every(i => i.disabled);
        }

        function saveWeek(childId, weekIndex) {
            // ako je veƒá zakljuƒçana, ne ≈°alji ponovo
            if (isColumnLocked(weekIndex)) return Promise.resolve();

            const inputs = Array.from(document.querySelectorAll(`[data-week="${weekIndex}"]`));
            if (!inputs.length) return Promise.resolve();

            // map to fetch promises
            const promises = inputs.map(input => {
                const activityId = input.getAttribute('data-activity');
                const score = parseInt(input.value) || 0;
                return fetch('/web/matrix/save-score', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `childId=${encodeURIComponent(childId)}&activityId=${encodeURIComponent(activityId)}&weekIndex=${encodeURIComponent(weekIndex)}&score=${encodeURIComponent(score)}`
                }).then(res => {
                    if (!res.ok) throw new Error('save-failed');
                    return res;
                });
            });

            return Promise.all(promises)
                .then(() => {
                    // nakon uspeha: zakljuƒçaj inpute i a≈æuriraj UI
                    inputs.forEach(input => {
                        input.disabled = true;
                        input.classList.add('locked');
                    });
                    const btn = getSaveButton(weekIndex);
                    if (btn) {
                        btn.textContent = '–ò–∑–º–µ–Ω–∏';
                        btn.classList.remove('save-btn'); btn.classList.add('edit-btn');
                        // zadr≈æi childId na dugmetu, handler za otkljuƒçavanje
                        btn.onclick = () => unlockWeek(weekIndex);
                    }
                })
                .catch(err => {
                    console.error('Save failed for week', weekIndex, err);
                    alert('–°–Ω–∏–º–∞—ö–µ –Ω–∏—ò–µ —É—Å–ø–µ–ª–æ –∑–∞ –Ω–µ–¥–µ—ô—É ' + (parseInt(weekIndex,10)+1) + '. –ü—Ä–æ–≤–µ—Ä–∏ –∫–æ–Ω–∑–æ–ª—É.');
                    throw err;
                });
        }

        function unlockWeek(weekIndex) {
            const inputs = Array.from(document.querySelectorAll(`[data-week="${weekIndex}"]`));
            inputs.forEach(input => {
                input.disabled = false;
                input.classList.remove('locked');
            });
            const btn = getSaveButton(weekIndex);
            if (!btn) return;
            btn.textContent = '–°–Ω–∏–º–∏';
            btn.classList.remove('edit-btn'); btn.classList.add('save-btn');
            // ostavi handler da ponovo pozove saveWeek sa data-child iz dugmeta
            btn.onclick = () => {
                const child = btn.dataset.child || /*[[${selectedChildId}]]*/ 0;
                saveWeek(child, parseInt(weekIndex, 10));
            };
        }

        /* Inicijalno vezivanje dugmadi i keyboard pona≈°anje */
        window.addEventListener('load', () => {
            // bind save buttons
            document.querySelectorAll('button[data-save-week]').forEach(btn => {
                // osiguraj da dugme ima data-child; ako nema, postavi default selectedChildId
                if (!btn.dataset.child) btn.dataset.child = /*[[${selectedChildId}]]*/ 0;
                btn.onclick = () => {
                    const child = btn.dataset.child;
                    const idx = parseInt(btn.dataset.saveWeek, 10);
                    saveWeek(child, idx);
                };
            });

            // keyboard: Tab i Enter pona≈°anje ‚Äî vertikalno po koloni
            // delegiramo na container tabele
            const table = document.querySelector('.matrix');
            if (!table) return;

            table.addEventListener('keydown', (ev) => {
                const target = ev.target;
                if (!(target instanceof HTMLInputElement) || target.getAttribute('type') !== 'number') return;

                if (ev.key === 'Tab' || ev.key === 'Enter') {
                    // spreƒçi default Tab prelazak horizontalno
                    ev.preventDefault();

                    const week = target.getAttribute('data-week');
                    if (!week) return;

                    // sve inpute u istoj koloni (iste nedelje) ‚Äî redosled u DOM
                    const colInputs = Array.from(document.querySelectorAll(`input[type="number"][data-week="${week}"]`));
                    const idx = colInputs.indexOf(target);
                    if (idx === -1) return;

                    // smer: Shift+Tab ide gore, Tab/Enter ide dole
                    const forward = !ev.shiftKey;
                    let nextIdx = forward ? idx + 1 : idx - 1;

                    // ako doƒëemo do ivice: wrap ili fokusiraj prvo/poslednje po ≈æelji
                    if (nextIdx < 0) nextIdx = 0;
                    if (nextIdx >= colInputs.length) nextIdx = colInputs.length - 1;

                    // fokus na sledeƒái input i select text (ako hoƒáe≈°)
                    const next = colInputs[nextIdx];
                    if (next) {
                        next.focus();
                        next.select && next.select();
                    }
                }
            });

            // pokreni poƒçetne proraƒçune
            if (typeof updateSubtotals === 'function') updateSubtotals();
        });

        /* Oƒçekuje se da u HTML-u svako dugme ima: data-save-week i data-child (selectedChildId).
           Primer dugmeta u HTML:
           <button type="button" data-save-week="${i}" data-child="${selectedChildId}" class="save-btn">–°–Ω–∏–º–∏</button>
        */
    </script>


</head>
<body>
<div class="main-container">

    <!-- ‚¨ÜÔ∏è –ò–∑–±–æ—Ä –¥–µ—Ç–µ—Ç–∞ -->
    <form method="get" action="/web/index">
        <div style="
            margin-top:0.5rem;
            margin-bottom:0.5rem;
            padding:1rem;
            background:#f0f4ff;
            border:1px solid #ccc;
            border-radius:8px;
            display:flex;
            align-items:center;
            gap:1rem;
            font-size:1.2rem;">
            <label for="childId" style="font-weight:bold;">üë§ –ò–∑–∞–±–µ—Ä–∏ –¥–µ—Ç–µ:</label>
            <select name="childId" id="childId" style="
                font-size:1.1rem;
                padding:0.4rem 0.6rem;
                border-radius:6px;
                border:1px solid #aaa;
                background:white;">
                <option th:each="child : ${children}"
                        th:value="${child.id}"
                        th:text="${child.name}"
                        th:selected="${child.id == selectedChildId}">
                </option>
            </select>
            <button type="submit" style="
                font-size:1rem;
                padding:0.5rem 1rem;
                background:#001f4d;
                color:white;
                border:none;
                border-radius:6px;
                cursor:pointer;">–ü—Ä–∏–∫–∞–∂–∏</button>
        </div>
    </form>

    <!-- üìä –û—Å–Ω–æ–≤–Ω–∏ –ø–æ–¥–∞—Ü–∏ —É —Ç—Ä–∏ –∫–æ–ª–æ–Ω–µ -->
    <div style="
        margin:0.5rem 0;
        background:#f0f4ff;
        padding:1rem;
        border:1px solid #ccc;
        border-radius:8px;
        display:flex;
        justify-content:space-between;
        flex-wrap:wrap;
        gap:1rem;">
        <!-- üí∞ –¢—Ä–µ–Ω—É—Ç–Ω–æ —Å—Ç–∞—ö–µ -->
        <div style="
            flex:1;
            min-width:220px;
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            text-align:center;">
            <h2 style="margin:0; font-size:1.6rem;">üí∞ –¢—Ä–µ–Ω—É—Ç–Ω–æ —Å—Ç–∞—ö–µ</h2>
            <p style="font-size:2rem; font-weight:bold; margin-top:0.5rem; margin-bottom:0;">
                <span th:text="${(startingBalance ?: 0) + (totalAllowance ?: 0) + (totalRewards ?: 0) - (totalPenalties ?: 0) + (totalGifts ?: 0)} + ' –¥–∏–Ω.'"></span>
            </p>
        </div>

        <!-- üìå –§–∏–Ω–∞–Ω—Å–∏—ò—Å–∫–∏ –æ–∫–≤–∏—Ä -->
        <div style="flex:1; min-width:220px;">
            <h3 style="margin-top:0;">üìå –§–∏–Ω–∞–Ω—Å–∏—ò—Å–∫–∏ –æ–∫–≤–∏—Ä</h3>
            <ul style="list-style:none; padding:0; font-size:1.1rem;">
                <li>–ù–µ–¥–µ—ô–Ω–∏ —ü–µ–ø–∞—Ä–∞—Ü: <strong th:text="${allowanceBase} + ' –¥–∏–Ω.'"></strong></li>
                <li>–ü–æ—á–µ—Ç–Ω–æ —Å—Ç–∞—ö–µ: <strong th:text="${startingBalance} + ' –¥–∏–Ω.'"></strong></li>
                <li>–£–∫—É–ø–∞–Ω —ü–µ–ø–∞—Ä–∞—Ü: <strong th:text="${totalAllowance} + ' –¥–∏–Ω.'"></strong></li>
            </ul>
        </div>

        <!-- üéÅ –ü–æ–¥—Å—Ç–∏—Ü–∞—ò–∏ –∏ –∫–æ—Ä–µ–∫—Ü–∏—ò–µ -->
        <div style="flex:1; min-width:220px;">
            <h3 style="margin-top:0;">üéÅ –ü–æ–¥—Å—Ç–∏—Ü–∞—ò–∏ –∏ –∫–æ—Ä–µ–∫—Ü–∏—ò–µ</h3>
            <ul style="list-style:none; padding:0; font-size:1.1rem;">
                <li>–ù–∞–≥—Ä–∞–¥–µ: <strong th:text="${totalRewards} + ' –¥–∏–Ω.'"></strong></li>
                <li>–ö–∞–∑–Ω–µ: <strong th:text="${totalPenalties} + ' –¥–∏–Ω.'"></strong></li>
                <li>–ü–æ–∫–ª–æ–Ω–∏ –∏ –±–æ–Ω—É—Å–∏: <strong th:text="${totalGifts} + ' –¥–∏–Ω.'"></strong></li>
            </ul>
        </div>
    </div>

    <!-- üìÖ –ú–∞—Ç—Ä–∏—Ü–∞ –æ—Ü–µ–Ω–∞ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏–º–∞ -->
    <div class="matrix-wrapper">
        <table class="matrix" style="
            border-collapse:collapse;
            font-size:0.8rem;
            text-align:center;
            width:max-content;
            min-width:100%;">
            <thead>
            <tr style="background:#cceccc;">
                <th style="border:1px solid #aaa;" class="col-activity">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç</th>
                <th style="border:1px solid #aaa;" class="col-desc">–û–ø–∏—Å</th>
                <th style="border:1px solid #aaa;" class="col-max">–ú–∞–∫—Å.</th>
                <th th:each="weekNum : ${#numbers.sequence(1,52)}"
                    th:text="'–ù' + weekNum"
                    style="border:1px solid #aaa; min-width:6rem;">
                </th>
            </tr>
            </thead>
            <tbody>

            <!-- üìò –û—Å–Ω–æ–≤–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (lista redova) -->
            <tr><td class="sec-header" colspan="55">üìò –û—Å–Ω–æ–≤–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</td></tr>
            <tr th:each="row : ${osnovneAktivnosti}">
                <td style="border:1px solid #aaa;" class="col-activity" th:text="${row.activity.name}">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç</td>
                <td style="border:1px solid #aaa;" class="col-desc" th:text="${row.activity.description}">–û–ø–∏—Å</td>
                <td style="border:1px solid #aaa;" class="col-max" th:text="${row.activity.maxScore}">0</td>
                <td th:each="score, iterStat : ${row.weeklyScores}" style="border:1px solid #aaa;">
                    <input type="number" th:value="${score}" th:attr="data-week=${iterStat.index}, data-activity=${row.activity.id}, data-section='osnovne'" style="width:4rem;" />
                </td>
            </tr>
            <tr class="coef-row">
                <td class="col-activity" colspan="3">–ö–æ–µ—Ñ–∏—Ü–∏—ò–µ–Ω—Ç –æ—Å–Ω–æ–≤–Ω–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</td>
                <td th:each="i : ${#numbers.sequence(0,51)}" th:id="'subtotal-osnovne-' + i">0</td>
            </tr>

            <!-- üìó –î–æ–¥–∞—Ç–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
            <tr><td class="sec-header" colspan="55">üìó –î–æ–¥–∞—Ç–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</td></tr>
            <tr th:each="row : ${dodatneAktivnosti}">
                <td style="border:1px solid #aaa;" class="col-activity" th:text="${row.activity.name}">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç</td>
                <td style="border:1px solid #aaa;" class="col-desc" th:text="${row.activity.description}">–û–ø–∏—Å</td>
                <td style="border:1px solid #aaa;" class="col-max" th:text="${row.activity.maxScore}">0</td>
                <td th:each="score, iterStat : ${row.weeklyScores}" style="border:1px solid #aaa;">
                    <input type="number" th:value="${score}" th:attr="data-week=${iterStat.index}, data-activity=${row.activity.id}, data-section='dodatne'" style="width:4rem;" />
                </td>
            </tr>
            <tr class="coef-row">
                <td class="col-activity" colspan="3">–ö–æ–µ—Ñ–∏—Ü–∏—ò–µ–Ω—Ç –¥–æ–¥–∞—Ç–Ω–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</td>
                <td th:each="i : ${#numbers.sequence(0,51)}" th:id="'subtotal-dodatne-' + i">0</td>
            </tr>

            <!-- üìô –¢–∏–º—Å–∫–∏ —Ä–∞–¥ -->
            <tr><td class="sec-header" colspan="55">üìô –¢–∏–º—Å–∫–∏ —Ä–∞–¥</td></tr>
            <tr th:each="row : ${timovi}">
                <td style="border:1px solid #aaa;" class="col-activity" th:text="${row.activity.name}">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç</td>
                <td style="border:1px solid #aaa;" class="col-desc" th:text="${row.activity.description}">–û–ø–∏—Å</td>
                <td style="border:1px solid #aaa;" class="col-max" th:text="${row.activity.maxScore}">0</td>
                <td th:each="score, iterStat : ${row.weeklyScores}" style="border:1px solid #aaa;">
                    <input type="number" th:value="${score}" th:attr="data-week=${iterStat.index}, data-activity=${row.activity.id}, data-section='timovi'" style="width:4rem;" />
                </td>
            </tr>
            <tr class="coef-row">
                <td class="col-activity" colspan="3">–ö–æ–µ—Ñ–∏—Ü–∏—ò–µ–Ω—Ç —Ç–∏–º—Å–∫–æ–≥ —Ä–∞–¥–∞</td>
                <td th:each="i : ${#numbers.sequence(0,51)}" th:id="'subtotal-timovi-' + i">0</td>
            </tr>

            <!-- —É–∫—É–ø–Ω–æ, —ü–µ–ø–∞—Ä–∞—Ü, —Å–Ω–∏–º–∏ -->
            <tr class="total-row">
                <td class="col-activity" colspan="3">–£–∫—É–ø–Ω–∞ –Ω–µ–¥–µ—ô–Ω–∞ –æ—Ü–µ–Ω–∞</td>
                <td th:each="i : ${#numbers.sequence(0,51)}" th:id="'koef-' + i">0</td>
            </tr>
            <tr class="allow-row">
                <td class="col-activity" colspan="3">–è–µ–ø–∞—Ä–∞—Ü</td>
                <td th:each="i : ${#numbers.sequence(0,51)}" th:id="'dzep-' + i">0</td>
            </tr>
            <tr class="save-row">
                <td class="col-activity" colspan="3">–°–Ω–∏–º–∏</td>
                <td th:each="i : ${#numbers.sequence(0,51)}">
                    <button type="button"
                            th:attr="data-save-week=${i}, data-child=${selectedChildId}"
                            class="save-btn">–°–Ω–∏–º–∏</button>
                </td>
            </tr>

            </tbody>
        </table>
    </div>

</div>
</body>
</html>
